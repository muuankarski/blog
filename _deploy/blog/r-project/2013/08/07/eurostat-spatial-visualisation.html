<!DOCTYPE html>
<html lang="en"> <!-- Set this to the main language of your site -->
<head>
	<!-- Define the page charset to be utf-8 -->
	<meta charset="utf-8" />
	
    <title>Spatial visualisation of Eurostat regional data Markus Kainu</title>
	
	<!-- Enter a brief description of your page -->
	<meta name="description" content="">
	
	<!-- Define a viewport to mobile devices to use - telling the browser to assume that the page is as wide as the device (width=device-width) and setting the initial page zoom level to be 1 (initial-scale=1.0) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Atom Feed -->
    <link href="/blog/feed.xml" rel="alternate" title="Markus Kainu's Blog Post Feed" type="application/atom+xml">
	
	<!-- Add normalize.css which enables browsers to render all elements more consistently and in line with modern standards as it only targets particular styles that need normalizing -->
	<link href="/css/normalize.css" rel="stylesheet" media="all" />

    <!-- Add bootstrap which makes everything better -->
    <link href="/css/readable-bootstrap.min.css" rel="stylesheet" media="all" />
    <link href="/css/font-awesome.min.css" rel="stylesheet" media="all" />
    <!--
    <link href="/css/bootstrap.min.css" rel="stylesheet" />
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="/css/bootstrap-responsive.min.css" rel="stylesheet" />

    <!-- Stylesheet for Pygments highlighting -->
    <link href="/css/pygments.css" rel="stylesheet" media="all" />

    <!-- Include the site stylesheet -->
	<link href="/css/styles.css" rel="stylesheet" media="all" />
	
	<!-- Include the HTML5 shiv and shiv print polyfills for Internet Explorer browsers 8 and below -->
	<!--[if lt IE 9]>
		<script src="/js/html5shiv.js" media="all"></script>
		<script src="/js/html5shiv-printshiv.js" media="print"></script>
	<![endif]-->

</head>
<body>

    <div class="container">

	<!-- The page header typically contains items such as your site heading, logo and possibly the main site navigation -->
	<!-- ARIA: the landmark role "banner" is set as it is the prime heading or internal title of the page --> 
	<header role="banner" class="subhead">
	
		<!-- ARIA: the landmark role "navigation" is added here as the element contains site navigation -->
		<div class="subnav">
			<!-- This can contain your site navigation either in an unordered list or even a paragraph that contains links that allow users to navigate your site -->
            <ul class="nav nav-pills pull-right">
                <li><a href="/blog/">blog</a></li>
                <li><a href="/about.html">about</a></li>
                <li><a href="/resources.html">resources</a></li>
                <li><a title="code" href="http://github.com/muuankarski">
                    <i class="icon-github"></i></a></li>
                <li><a title="tweets" href="https://twitter.com/muuankarski">
                    <i class="icon-twitter"></i></a></li>
                <li><a title="email" href="mailto:markuskainu@gmail.com">
                    <i class="icon-envelope"></i></a></li>
            </ul>
		</div>

		<h3><a href="/">Markus Kainu</a></h3>	
		
	</header>
	
	<!-- If you want to use an element as a wrapper, i.e. for styling only, then <div> is still the element to use -->
	<div class="wrap content shadow">
	
        <h1 class="pull-right"><small>Wednesday - Aug 07, 2013</small></h1>

<h1 class="post-title">Spatial visualisation of Eurostat regional data</h1>

<p>This is only a a brief description how to access and use spatial shapefiles of Europe published by EUROSTAT at <a href="http://epp.eurostat.ec.europa.eu/portal/page/portal/gisco_Geographical_information_maps/popups/references/administrative_units_statistical_units_1">Administrative units / Statistical units</a>. Here I&#39;m using the 1:60 million scale Shapefile from year 2010.</p>

<p>As a plotted data we use the nuts2-level rates of material deprivation which we import from EUROSTAT on page using <a href="http://cran.r-project.org/web/packages/SmarterPoland/index.html">SmarterPoland-package</a>.(see <a href="http://markuskainu.fi/r-tutorial/eurostat/smarterpoland.html">SmarterPoland-package</a> for more examples)</p>

<h2>Importing the data</h2>

<div class="highlight"><pre><code class="r">library<span class="p">(</span>SmarterPoland<span class="p">)</span>
df <span class="o">&lt;-</span> getEurostatRaw<span class="p">(</span>kod <span class="o">=</span> <span class="s">&quot;ilc_mddd21&quot;</span><span class="p">)</span>
<span class="c1">#</span>
names<span class="p">(</span>df<span class="p">)</span> <span class="o">&lt;-</span> c<span class="p">(</span><span class="s">&quot;xx&quot;</span><span class="p">,</span> <span class="m">2011</span><span class="o">:</span><span class="m">2003</span><span class="p">)</span>

df<span class="o">$</span>unit <span class="o">&lt;-</span> lapply<span class="p">(</span>strsplit<span class="p">(</span>as.character<span class="p">(</span>df<span class="o">$</span>xx<span class="p">),</span> <span class="s">&quot;,&quot;</span><span class="p">),</span> <span class="s">&quot;[&quot;</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
df<span class="o">$</span>geo.time <span class="o">&lt;-</span> lapply<span class="p">(</span>strsplit<span class="p">(</span>as.character<span class="p">(</span>df<span class="o">$</span>xx<span class="p">),</span> <span class="s">&quot;,&quot;</span><span class="p">),</span> <span class="s">&quot;[&quot;</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>

df.l <span class="o">&lt;-</span> melt<span class="p">(</span>data <span class="o">=</span> df<span class="p">,</span> id.vars <span class="o">=</span> <span class="s">&quot;geo.time&quot;</span><span class="p">,</span> measure.vars <span class="o">=</span> c<span class="p">(</span><span class="s">&quot;2003&quot;</span><span class="p">,</span> <span class="s">&quot;2004&quot;</span><span class="p">,</span> 
    <span class="s">&quot;2005&quot;</span><span class="p">,</span> <span class="s">&quot;2006&quot;</span><span class="p">,</span> <span class="s">&quot;2007&quot;</span><span class="p">,</span> <span class="s">&quot;2008&quot;</span><span class="p">,</span> <span class="s">&quot;2009&quot;</span><span class="p">,</span> <span class="s">&quot;2010&quot;</span><span class="p">,</span> <span class="s">&quot;2011&quot;</span><span class="p">))</span>

df.l<span class="o">$</span>geo.time <span class="o">&lt;-</span> unlist<span class="p">(</span>df.l<span class="o">$</span>geo.time<span class="p">)</span>  <span class="c1"># unlist the geo.time variable</span>
</code></pre></div>

<h2>Load the GISCO shapefile, subset it to NUTS2-level and merge the Eurostat attribute data with it into single <code>SpatialPolygonDataFrame</code></h2>

<div class="highlight"><pre><code class="r">download.file<span class="p">(</span><span class="s">&quot;http://epp.eurostat.ec.europa.eu/cache/GISCO/geodatafiles/NUTS_2010_60M_SH.zip&quot;</span><span class="p">,</span> 
    destfile <span class="o">=</span> <span class="s">&quot;NUTS_2010_60M_SH.zip&quot;</span><span class="p">)</span>
<span class="c1"># unzip to SpatialPolygonsDataFrame</span>
unzip<span class="p">(</span><span class="s">&quot;NUTS_2010_60M_SH.zip&quot;</span><span class="p">)</span>
library<span class="p">(</span>rgdal<span class="p">)</span>
map <span class="o">&lt;-</span> readOGR<span class="p">(</span>dsn <span class="o">=</span> <span class="s">&quot;./NUTS_2010_60M_SH/data&quot;</span><span class="p">,</span> layer <span class="o">=</span> <span class="s">&quot;NUTS_RG_60M_2010&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><code class="text">## OGR data source with driver: ESRI Shapefile 
## Source: &quot;./NUTS_2010_60M_SH/data&quot;, layer: &quot;NUTS_RG_60M_2010&quot;
## with 1920 features and 4 fields
## Feature type: wkbPolygon with 2 dimensions
</code></pre></div>

<div class="highlight"><pre><code class="r"><span class="c1"># as the data is at NUTS2-level, we subset the spatialpolygondataframe</span>
map_nuts2 <span class="o">&lt;-</span> subset<span class="p">(</span>map<span class="p">,</span> STAT_LEVL_ <span class="o">&lt;=</span> <span class="m">2</span><span class="p">)</span>
<span class="c1"># dim show how many regions are in the spatialpolygondataframe</span>
dim<span class="p">(</span>map_nuts2<span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><code class="text">## [1] 467   4
</code></pre></div>

<div class="highlight"><pre><code class="r"><span class="c1"># dim show how many regions are in the data.frame</span>
dim<span class="p">(</span>df<span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><code class="text">## [1] 223  13
</code></pre></div>

<div class="highlight"><pre><code class="r"><span class="c1"># Spatial dataframe has 467 rows and attribute data 223.  We need to make</span>
<span class="c1"># attribute data to have similar number of rows</span>
NUTS_ID <span class="o">&lt;-</span> as.character<span class="p">(</span>map_nuts2<span class="o">$</span>NUTS_ID<span class="p">)</span>
VarX <span class="o">&lt;-</span> rep<span class="p">(</span><span class="s">&quot;empty&quot;</span><span class="p">,</span> <span class="m">467</span><span class="p">)</span>
dat <span class="o">&lt;-</span> data.frame<span class="p">(</span>NUTS_ID<span class="p">,</span> VarX<span class="p">)</span>
<span class="c1"># then we shall merge this with Eurostat data.frame</span>
dat2 <span class="o">&lt;-</span> merge<span class="p">(</span>dat<span class="p">,</span> df<span class="p">,</span> by.x <span class="o">=</span> <span class="s">&quot;NUTS_ID&quot;</span><span class="p">,</span> by.y <span class="o">=</span> <span class="s">&quot;geo.time&quot;</span><span class="p">,</span> all.x <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## merge this manipulated attribute data with the spatialpolygondataframe</span>
<span class="c1">## there are still duplicates in the data, remove them</span>
dat2<span class="o">$</span>dup <span class="o">&lt;-</span> duplicated<span class="p">(</span>dat2<span class="o">$</span>NUTS_ID<span class="p">)</span>
dat3 <span class="o">&lt;-</span> subset<span class="p">(</span>dat2<span class="p">,</span> dup <span class="o">==</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="c1">## rownames</span>
row.names<span class="p">(</span>dat3<span class="p">)</span> <span class="o">&lt;-</span> dat3<span class="o">$</span>NUTS_ID
row.names<span class="p">(</span>map_nuts2<span class="p">)</span> <span class="o">&lt;-</span> as.character<span class="p">(</span>map_nuts2<span class="o">$</span>NUTS_ID<span class="p">)</span>
<span class="c1">## order data</span>
dat3 <span class="o">&lt;-</span> dat3<span class="p">[</span>order<span class="p">(</span>row.names<span class="p">(</span>dat3<span class="p">)),</span> <span class="p">]</span>
map_nuts2 <span class="o">&lt;-</span> map_nuts2<span class="p">[</span>order<span class="p">(</span>row.names<span class="p">(</span>map_nuts2<span class="p">)),</span> <span class="p">]</span>
<span class="c1">## join</span>
library<span class="p">(</span>maptools<span class="p">)</span>
shape <span class="o">&lt;-</span> spCbind<span class="p">(</span>map_nuts2<span class="p">,</span> dat3<span class="p">)</span>
</code></pre></div>

<h2>Munging the shapefile into data.frame and ready for ggplot-plotting</h2>

<div class="highlight"><pre><code class="r"><span class="c1">## fortify spatialpolygondataframe into data.frame</span>
library<span class="p">(</span>ggplot2<span class="p">)</span>
library<span class="p">(</span>rgeos<span class="p">)</span>
shape<span class="o">$</span>id <span class="o">&lt;-</span> rownames<span class="p">(</span>shape<span class="o">@</span>data<span class="p">)</span>
map.points <span class="o">&lt;-</span> fortify<span class="p">(</span>shape<span class="p">,</span> region <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="p">)</span>
map.df <span class="o">&lt;-</span> merge<span class="p">(</span>map.points<span class="p">,</span> shape<span class="p">,</span> by <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="p">)</span>
<span class="c1"># As we want to plot map faceted by years from 2003 to 2011 we have to</span>
<span class="c1"># melt it into long format</span>
library<span class="p">(</span>reshape2<span class="p">)</span>
map.df.l <span class="o">&lt;-</span> melt<span class="p">(</span>data <span class="o">=</span> map.df<span class="p">,</span> id.vars <span class="o">=</span> c<span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;long&quot;</span><span class="p">,</span> <span class="s">&quot;lat&quot;</span><span class="p">,</span> <span class="s">&quot;group&quot;</span><span class="p">),</span> measure.vars <span class="o">=</span> c<span class="p">(</span><span class="s">&quot;X2003&quot;</span><span class="p">,</span> 
    <span class="s">&quot;X2004&quot;</span><span class="p">,</span> <span class="s">&quot;X2005&quot;</span><span class="p">,</span> <span class="s">&quot;X2006&quot;</span><span class="p">,</span> <span class="s">&quot;X2007&quot;</span><span class="p">,</span> <span class="s">&quot;X2008&quot;</span><span class="p">,</span> <span class="s">&quot;X2009&quot;</span><span class="p">,</span> <span class="s">&quot;X2010&quot;</span><span class="p">,</span> <span class="s">&quot;X2011&quot;</span><span class="p">))</span>
<span class="c1"># year variable (variable) is class string and type X20xx.  Lets remove</span>
<span class="c1"># the X and convert it to numerical</span>
library<span class="p">(</span>stringr<span class="p">)</span>
map.df.l<span class="o">$</span>variable <span class="o">&lt;-</span> str_replace_all<span class="p">(</span>map.df.l<span class="o">$</span>variable<span class="p">,</span> <span class="s">&quot;X&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
map.df.l<span class="o">$</span>variable <span class="o">&lt;-</span> factor<span class="p">(</span>map.df.l<span class="o">$</span>variable<span class="p">)</span>
map.df.l<span class="o">$</span>variable <span class="o">&lt;-</span> as.numeric<span class="p">(</span>levels<span class="p">(</span>map.df.l<span class="o">$</span>variable<span class="p">))[</span>map.df.l<span class="o">$</span>variable<span class="p">]</span>
</code></pre></div>

<h2>And finally the plot using ggplot2</h2>

<p>Map shows proportion of materially deprived households at the NUTS2 level. Grey color indicates missing data.</p>

<div class="highlight"><pre><code class="r">library<span class="p">(</span>ggplot2<span class="p">)</span>
<span class="c1"># plot faceted by year</span>
ggplot<span class="p">(</span>map.df.l<span class="p">,</span> aes<span class="p">(</span>long<span class="p">,</span>lat<span class="p">,</span>group<span class="o">=</span>group<span class="p">))</span> <span class="o">+</span>
  geom_polygon<span class="p">(</span>aes<span class="p">(</span>fill <span class="o">=</span> value<span class="p">))</span> <span class="o">+</span>
  geom_polygon<span class="p">(</span>data <span class="o">=</span> map.df.l<span class="p">,</span> aes<span class="p">(</span>long<span class="p">,</span>lat<span class="p">),</span> 
               fill<span class="o">=</span><span class="kc">NA</span><span class="p">,</span> 
               color <span class="o">=</span> <span class="s">&quot;white&quot;</span><span class="p">,</span>
               size<span class="o">=</span><span class="m">0.1</span><span class="p">)</span> <span class="o">+</span> <span class="c1"># white borders</span>
  coord_map<span class="p">(</span>project<span class="o">=</span><span class="s">&quot;orthographic&quot;</span><span class="p">,</span> xlim<span class="o">=</span>c<span class="p">(</span><span class="m">-22</span><span class="p">,</span><span class="m">34</span><span class="p">),</span>
              ylim<span class="o">=</span>c<span class="p">(</span><span class="m">35</span><span class="p">,</span><span class="m">70</span><span class="p">))</span> <span class="o">+</span> <span class="c1"># projection</span>
  facet_wrap<span class="p">(</span><span class="o">~</span>variable<span class="p">)</span> <span class="o">+</span>
  theme_minimal<span class="p">()</span>
</code></pre></div>

<p><img src="/figs/2013-08-07-eurostat-spatial-visualisation/facetmap.png" alt="center"> </p>


<!--
<small class="well" style="padding: 6px;">

    Follow me on <a href="http://twitter.com/muuankarski">Twitter</a>.

</small>
-->

<div style="margin: 15px 0; padding-top: 5px; border-top: 1px solid lightgray;">

<small class="pull-right">
    <a href="/blog/r-project/2013/08/08/rustfare-rosstat-regional.html"
    
    >rustfare-package and using Rosstat regional statistics &rarr;</a>
</small>



<small>
    <a href="/blog/r-project/2013/08/06/eurostat-smarter-poland.html" title="">&larr; Using SmarterPoland-package in accessing Eurostat data</a>
</small>


</div>

<!--
<div style="font-size: 85%;">
Related Posts:
<ul>

    <li><a href="/blog/r-project/2013/11/14/world-values-survey-on-map.html" title="">Visualising World Values Survey on a Map in R</a></li>

    <li><a href="/blog/tools/2013/10/15/markdown-pandoc-tieteellinen-teksti.html" title="">Markdown ja pandoc - tekstipohjaisen tieteellisen kirjoittamisen työvirta</a></li>

    <li><a href="/blog/r-project/2013/09/17/economic-history-dataset-in-r.html" title="">Maddison Project database in R</a></li>

</ul>
</div>
-->

<!--

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'joshbranchaud'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
-->


 <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'markuskainuresearchblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    



		
	</div>


	
	<!-- The main page footer can contain items such as copyright and contact information. It can also contain a duplicated navigation of your site which is not usually contained within a <nav> -->
	<!-- ARIA: the landmark role "contentinfo" is added here as it contains metadata that applies to the parent document -->
	<footer role="contentinfo" style="margin: 10px 5px;">

        <small class="pull-right">With a little help from <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://getbootstrap.com/">Bootstrap</a></small>

		<!-- Copyright information can be contained within the <small> element. The <time> element is used here to indicate that the '2012' is a date -->
		<small>Copyright &copy; <a href="http://markuskainu.fi">Markus Kainu</a> <time datetime="2013">2013</time></small>
		
	</footer>

    </div>
	
	
</body>
</html>

